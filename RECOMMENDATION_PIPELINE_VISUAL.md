# ğŸ¯ Pachu Recommendation Pipeline - Visual Guide

## ğŸ“Š Pipeline Overview (Funnel)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ğŸ—„ï¸  DATABASE                                    â”‚
â”‚                      ~2000 ××¡×¢×“×•×ª                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  ğŸ”§ STEP 1: HARD FILTERS                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚       Location           â”‚  â”‚        Hours             â”‚        â”‚
â”‚  â”‚    (distance radius)     â”‚  â”‚     (open now?)          â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                                     â”‚
â”‚  âš ï¸ ONLY hard single-value filters:                                 â”‚
â”‚  â€¢ city = Tel Aviv                                                  â”‚
â”‚  â€¢ distance <= radius (based on user preference)                    â”‚
â”‚  â€¢ opening_hours (only if when='now')                              â”‚
â”‚                                                                     â”‚
â”‚  âŒ Budget is NOT a hard filter - handled in reranking              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                        ~800 ××¡×¢×“×•×ª
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  ğŸ§  STEP 2: VECTOR SEARCH                           â”‚
â”‚                                                                     â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚    â”‚              ğŸ¯ Query Embedding Generation                   â”‚ â”‚
â”‚    â”‚                                                              â”‚ â”‚
â”‚    â”‚   User Request â†’ "Italian food, romantic dinner for two"   â”‚ â”‚
â”‚    â”‚                         â”‚                                    â”‚ â”‚
â”‚    â”‚                         â–¼                                    â”‚ â”‚
â”‚    â”‚              OpenAI text-embedding-3-small                   â”‚ â”‚
â”‚    â”‚                         â”‚                                    â”‚ â”‚
â”‚    â”‚                         â–¼                                    â”‚ â”‚
â”‚    â”‚              [1536-dimensional vector]                       â”‚ â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                     â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚    â”‚              ğŸ‘¤ User Profile Embedding (Optional)            â”‚ â”‚
â”‚    â”‚                                                              â”‚ â”‚
â”‚    â”‚   Priority: combined_embedding > onboarding_embedding       â”‚ â”‚
â”‚    â”‚                                                              â”‚ â”‚
â”‚    â”‚   Combined embedding includes:                               â”‚ â”‚
â”‚    â”‚   â€¢ Onboarding preferences                                   â”‚ â”‚
â”‚    â”‚   â€¢ Past reviews                                             â”‚ â”‚
â”‚    â”‚   â€¢ Likes, comments, wishlist activity                       â”‚ â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                     â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚    â”‚              ğŸ”€ Final Embedding Combination                  â”‚ â”‚
â”‚    â”‚                                                              â”‚ â”‚
â”‚    â”‚    finalEmbedding = queryEmbedding Ã— 0.7                    â”‚ â”‚
â”‚    â”‚                   + userEmbedding  Ã— 0.3                    â”‚ â”‚
â”‚    â”‚                                                              â”‚ â”‚
â”‚    â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚ â”‚
â”‚    â”‚    â”‚ Query: 70%     â”‚ +  â”‚ User: 30%      â”‚ = Final         â”‚ â”‚
â”‚    â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚ â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                     â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚    â”‚              ğŸ“Š Restaurant Scoring                           â”‚ â”‚
â”‚    â”‚                                                              â”‚ â”‚
â”‚    â”‚   For each restaurant:                                       â”‚ â”‚
â”‚    â”‚                                                              â”‚ â”‚
â”‚    â”‚   summaryScore = cosineSimilarity(final, summary_embedding) â”‚ â”‚
â”‚    â”‚   reviewsScore = cosineSimilarity(final, reviews_embedding) â”‚ â”‚
â”‚    â”‚                                                              â”‚ â”‚
â”‚    â”‚   vectorScore = summaryScore Ã— 0.7 + reviewsScore Ã— 0.3     â”‚ â”‚
â”‚    â”‚                                                              â”‚ â”‚
â”‚    â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚ â”‚
â”‚    â”‚    â”‚ Summary: 70%   â”‚ +  â”‚ Reviews: 30%   â”‚ = vectorScore   â”‚ â”‚
â”‚    â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚ â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                     â”‚
â”‚  Output: All restaurants sorted by vectorScore (0.0 - 1.0)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                        ~800 ××¡×¢×“×•×ª (sorted)
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  âš¡ STEP 3: RE-RANKING                              â”‚
â”‚                                                                     â”‚
â”‚    socialScore = 0  (××ª×—×™×œ ×××¤×¡ ×•××•×¡×™×£/××•×¨×™×“ × ×§×•×“×•×ª)               â”‚
â”‚                                                                     â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚    â”‚  ğŸ‘¥ Friends Signal                                           â”‚ â”‚
â”‚    â”‚                                                              â”‚ â”‚
â”‚    â”‚  If friends visited: +0.2 per friend (max +0.6)             â”‚ â”‚
â”‚    â”‚                                                              â”‚ â”‚
â”‚    â”‚  1 friend  â†’ +0.2                                           â”‚ â”‚
â”‚    â”‚  2 friends â†’ +0.4                                           â”‚ â”‚
â”‚    â”‚  3+ friends â†’ +0.6 (capped)                                 â”‚ â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                     â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚    â”‚  â­ Google Rating Signal                                     â”‚ â”‚
â”‚    â”‚                                                              â”‚ â”‚
â”‚    â”‚  Rating >= 4.5 â†’ +0.10                                      â”‚ â”‚
â”‚    â”‚  Rating >= 4.0 â†’ +0.05                                      â”‚ â”‚
â”‚    â”‚  Rating <  4.0 â†’ +0.00                                      â”‚ â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                     â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚    â”‚  ğŸ“ˆ Popularity Signal (Review Count)                         â”‚ â”‚
â”‚    â”‚                                                              â”‚ â”‚
â”‚    â”‚  Reviews > 1000 â†’ +0.10                                     â”‚ â”‚
â”‚    â”‚  Reviews > 500  â†’ +0.05                                     â”‚ â”‚
â”‚    â”‚  Reviews <= 500 â†’ +0.00                                     â”‚ â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                     â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚    â”‚  ğŸ“ Distance Penalty                                         â”‚ â”‚
â”‚    â”‚                                                              â”‚ â”‚
â”‚    â”‚  penalty = distance_in_km Ã— -0.01                           â”‚ â”‚
â”‚    â”‚                                                              â”‚ â”‚
â”‚    â”‚  1km away  â†’ -0.01                                          â”‚ â”‚
â”‚    â”‚  5km away  â†’ -0.05                                          â”‚ â”‚
â”‚    â”‚  10km away â†’ -0.10                                          â”‚ â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                     â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚    â”‚  ğŸ­ Occasion-Based Boosts                                    â”‚ â”‚
â”‚    â”‚                                                              â”‚ â”‚
â”‚    â”‚  If date + rating >= 4.3     â†’ +0.10                        â”‚ â”‚
â”‚    â”‚  If quick_bite + price <= 2  â†’ +0.10                        â”‚ â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                     â”‚
â”‚    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•— â”‚
â”‚    â•‘  FINAL SCORE = vectorScore + socialScore                    â•‘ â”‚
â”‚    â•‘                                                              â•‘ â”‚
â”‚    â•‘  Example:                                                    â•‘ â”‚
â”‚    â•‘  vectorScore = 0.85                                         â•‘ â”‚
â”‚    â•‘  socialScore = 0.40 + 0.10 + 0.05 - 0.02 = 0.53            â•‘ â”‚
â”‚    â•‘  finalScore  = 0.85 + 0.53 = 1.38                          â•‘ â”‚
â”‚    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• â”‚
â”‚                                                                     â”‚
â”‚  Output: All restaurants sorted by finalScore                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                        Top 15 candidates
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  ğŸ¤– STEP 4: LLM SELECTION (PERSONALIZED!)           â”‚
â”‚                                                                     â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚    â”‚  Input to GPT-4o-mini:                                       â”‚ â”‚
â”‚    â”‚                                                              â”‚ â”‚
â”‚    â”‚  ğŸ“‹ USER PERSONAL PROFILE:                                   â”‚ â”‚
â”‚    â”‚    â€¢ Name (for personal greeting)                            â”‚ â”‚
â”‚    â”‚    â€¢ Onboarding: likes, dislikes, dietary requirements      â”‚ â”‚
â”‚    â”‚    â€¢ Recent reviews (last 10 with ratings & content)        â”‚ â”‚
â”‚    â”‚    â€¢ Friends they follow (for social context)               â”‚ â”‚
â”‚    â”‚                                                              â”‚ â”‚
â”‚    â”‚  ğŸ” SEARCH CONTEXT:                                          â”‚ â”‚
â”‚    â”‚    â€¢ Occasion (date/friends/family/solo/work)               â”‚ â”‚
â”‚    â”‚    â€¢ Budget preference                                       â”‚ â”‚
â”‚    â”‚    â€¢ Cuisine preference                                      â”‚ â”‚
â”‚    â”‚    â€¢ Location preference                                     â”‚ â”‚
â”‚    â”‚                                                              â”‚ â”‚
â”‚    â”‚  ğŸ† TOP 15 CANDIDATES:                                       â”‚ â”‚
â”‚    â”‚    - Name, categories, rating, review count                 â”‚ â”‚
â”‚    â”‚    - Price level, distance, summary                         â”‚ â”‚
â”‚    â”‚    - Friends who visited (social proof!)                    â”‚ â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                     â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚    â”‚  Output from LLM:                                            â”‚ â”‚
â”‚    â”‚                                                              â”‚ â”‚
â”‚    â”‚  Top 3 PERSONAL recommendations with Hebrew explanations    â”‚ â”‚
â”‚    â”‚                                                              â”‚ â”‚
â”‚    â”‚  Example reasons (personalized!):                           â”‚ â”‚
â”‚    â”‚  â€¢ "×“× ×™, ×‘×”×ª×‘×¡×¡ ×¢×œ ×”××”×‘×” ×©×œ×š ×œ××™×˜×œ×§×™ ×‘-Pasta Basta..."     â”‚ â”‚
â”‚    â”‚  â€¢ "×”×—×‘×¨ ×©×œ×š ×™×•×¡×™ ×”×™×” ×¤×” ×•× ×ª×Ÿ 5 ×›×•×›×‘×™×!"                   â”‚ â”‚
â”‚    â”‚  â€¢ "××•×©×œ× ×œ×“×™×™×˜ - ×¨×•×× ×˜×™ ×•×’× ××ª××™× ×œ×¦××—×•× ×™ ×©×œ×š"            â”‚ â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  ğŸ‰ FINAL OUTPUT: 3 Recommendations                 â”‚
â”‚                                                                     â”‚
â”‚    [                                                                â”‚
â”‚      {                                                              â”‚
â”‚        restaurant: { name, address, rating, photos, ... },         â”‚
â”‚        reason: "× ×™××•×§ ×œ××” ×”××§×•× ××ª××™×",                            â”‚
â”‚        matchScore: 85  (finalScore Ã— 100)                          â”‚
â”‚      },                                                             â”‚
â”‚      ...                                                            â”‚
â”‚    ]                                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”¢ Weight Summary Table

### Vector Search Weights

| Component | Weight | Description |
|-----------|--------|-------------|
| Query Embedding | **70%** | What the user asked for now |
| User Profile Embedding | **30%** | User's taste history |
| Summary Embedding | **70%** | Restaurant's description match |
| Reviews Embedding | **30%** | Restaurant's reviews match |

### Re-ranking Signals

| Signal | Value | Condition |
|--------|-------|-----------|
| Friends visited | +0.20 | Per friend (max 3 = +0.60) |
| Google Rating â‰¥ 4.5 | +0.10 | High quality |
| Google Rating â‰¥ 4.0 | +0.05 | Good quality |
| Reviews > 1000 | +0.10 | Very popular |
| Reviews > 500 | +0.05 | Popular |
| Distance | -0.01/km | Closer is better |
| **Budget: cheap** | +0.15 / +0.05 / -0.10 | $ / $$ / $$$ |
| **Budget: moderate** | +0.10 / 0 / -0.05 | $$ / $-$$$ / $$$$ |
| **Budget: expensive** | +0.15 / 0 / -0.10 | $$$+ / $$ / $ |
| Date + Rating â‰¥ 4.3 | +0.10 | Romantic context boost |
| Quick bite + Cheap | +0.10 | Context-appropriate |

---

## ğŸ“ Embedding Dimensions

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  OpenAI text-embedding-3-small                         â”‚
â”‚  Dimension: 1536                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Restaurant Embeddings (stored in DB):
â”œâ”€â”€ summary_embedding [1536]  â† Generated from restaurant description
â””â”€â”€ reviews_embedding [1536]  â† Generated from user reviews text

User Embeddings (stored in DB):
â”œâ”€â”€ onboarding_embedding [1536]  â† From onboarding preferences
â”œâ”€â”€ reviews_embedding [1536]     â† From user's own reviews
â”œâ”€â”€ chat_summary_embedding [1536] â† From chat conversations
â””â”€â”€ combined_embedding [1536]    â† Weighted average of all above
```

---

## ğŸšï¸ Adjustable Parameters

### Easy to Change:

```javascript
// In performVectorSearch():
const finalEmbedding = combineEmbeddings(queryEmbedding, userEmbedding, 0.7, 0.3);
                                                        // â†‘ query  â†‘ user

// Restaurant scoring:
r.vectorScore = summaryScore * 0.7 + reviewsScore * 0.3;
                          // â†‘ summary  â†‘ reviews

// In rerank():
socialScore += 0.2 * Math.min(friendsWhoVisited.length, 3);  // Friends weight
if (r.google_rating >= 4.5) socialScore += 0.1;              // Rating boost
if (r.google_reviews_count > 1000) socialScore += 0.1;       // Popularity boost
socialScore -= distanceKm * 0.01;                             // Distance penalty
```

---

## ğŸ“Š Score Ranges

```
vectorScore:  0.0 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 1.0
              (no match)              (perfect match)

socialScore: -0.15 â”€â”€â”€â”€â”€â”€â”€ 0.0 â”€â”€â”€â”€â”€â”€â”€ +0.96
             (far, low rated)    (friends, high rated)

finalScore:  -0.15 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ~2.0
             (worst case)           (perfect + social)
```

---

## ğŸ”„ Data Flow Diagram

```
USER INPUT                    DATABASE
    â”‚                            â”‚
    â–¼                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Message â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ restaurant  â”‚
â”‚ Locationâ”‚               â”‚   _cache    â”‚
â”‚ Context â”‚               â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚ â€¢ id        â”‚
    â”‚                     â”‚ â€¢ name      â”‚
    â”‚                     â”‚ â€¢ summary   â”‚
    â”‚                     â”‚ â€¢ embedding â”‚
    â”‚                     â”‚ â€¢ location  â”‚
    â”‚                     â”‚ â€¢ rating    â”‚
    â”‚                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚                            â”‚
    â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚    â”‚
    â–¼    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          RECOMMENDATION ENGINE          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. Hard Filter   â†’ by location/budget â”‚
â”‚  2. Vector Search â†’ by embeddings      â”‚
â”‚  3. Re-rank      â†’ by social signals   â”‚
â”‚  4. LLM Select   â†’ final 3 picks       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3 Recommendationsâ”‚
â”‚ with reasons     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ§ª Testing & Debugging

Use the **Analytics Page** (`/agent/analytics`) to see:
1. Total restaurants in DB
2. After hard filters count
3. Vector scores distribution
4. Re-ranking scores
5. Candidates sent to LLM
6. Final 3 selections

Password: `166147`
